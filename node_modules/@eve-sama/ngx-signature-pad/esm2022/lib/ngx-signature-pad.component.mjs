import { Component, Input, Output, EventEmitter, ViewChild } from '@angular/core';
import SignaturePad from 'signature_pad';
import { TemplatePortal } from '@angular/cdk/portal';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/overlay";
import * as i2 from "@angular/common";
class NgxSignaturePadComponent {
    renderer2;
    overlay;
    viewContainerRef;
    // #region The object of dependency 'siganture_pad'
    smallPad;
    bigPad;
    // #endregion
    // #region The object of canvas
    smallCanvas;
    bigCanvas;
    // #endregion
    // #region CDK
    overlayRef;
    portal;
    // #endregion
    signDataHistory = [];
    fullScreenWidth;
    fullScreenHeight;
    _isEmpty = true;
    isFullScreen = false;
    sectionHeight;
    get activePad() {
        return this.isFullScreen ? this.bigPad : this.smallPad;
    }
    options = {};
    beginSign = new EventEmitter();
    endSign = new EventEmitter();
    fullScreenTpl;
    nspSmall;
    nspBig;
    fullScreen() {
        this.portal = new TemplatePortal(this.fullScreenTpl, this.viewContainerRef);
        this.overlayRef = this.overlay.create({
            positionStrategy: this.overlay.position().global(),
            scrollStrategy: this.overlay.scrollStrategies.block(),
            height: '100%',
            width: '100%'
        });
        this.overlayRef.attach(this.portal);
        setTimeout(() => {
            this.initBigPad();
            // #region Copy miniScreen's content to fullScreen
            const { width: miniScreenWidth, height: miniScreenHeight } = this.options;
            const ctx = this.bigCanvas.getContext('2d');
            ctx.save();
            ctx.translate(this.fullScreenWidth, 0);
            ctx.rotate((90 * Math.PI) / 180);
            ctx.drawImage(this.smallCanvas, 0, 0, miniScreenWidth, miniScreenHeight, 0, 0, this.fullScreenHeight, this.fullScreenWidth);
            ctx.restore();
            // #endregion
        }, 0);
        this.isFullScreen = true;
    }
    miniScreen() {
        this.smallPad.clear();
        // #region Copy fullScreen's content to miniScreen
        const { width: miniScreenWidth, height: miniScreenHeight } = this.options;
        const widthScale = miniScreenWidth / this.fullScreenHeight;
        const heightScale = miniScreenHeight / this.fullScreenWidth;
        const ctx = this.smallCanvas.getContext('2d');
        ctx.save();
        ctx.translate(0, miniScreenHeight);
        ctx.rotate((-90 * Math.PI) / 180);
        ctx.drawImage(this.bigCanvas, 0, 0, this.fullScreenWidth, this.fullScreenHeight, 0, 0, this.fullScreenWidth * widthScale, this.fullScreenHeight * heightScale);
        ctx.restore();
        // #endregion
        this.overlayRef.dispose();
        this.bigCanvas = null;
        this.bigPad = null;
        this.isFullScreen = false;
    }
    /** Returns signature image as an array of point groups */
    toData() {
        return this.activePad.toData();
    }
    /** Draws signature image from an array of point groups */
    fromData(pointGroups) {
        this.activePad.fromData(pointGroups);
    }
    toDataURL(type) {
        switch (type) {
            case 'image/jpeg':
                return this.activePad.toDataURL('image/jpeg');
            case 'image/svg+xml':
                return this.activePad.toDataURL('image/svg+xml');
            default:
                return this.activePad.toDataURL();
        }
    }
    fromDataURL(dataUrl, options, callback) {
        this.activePad.fromDataURL(dataUrl, options, callback);
    }
    revert() {
        this.signDataHistory.pop();
        this.fromData(this.signDataHistory);
        if (this.signDataHistory.length === 0) {
            this.setEmpty();
        }
    }
    // Clears the canvas
    clear() {
        this.setEmpty();
        this.signDataHistory = [];
        this.activePad.clear();
    }
    /** Return true if canvas is empty, otherwise return false */
    isEmpty() {
        return this._isEmpty;
    }
    /** Set canvas's state as dirty */
    setDirty() {
        this._isEmpty = false;
    }
    /** Set canvas's state as empty */
    setEmpty() {
        this._isEmpty = true;
    }
    getContext() {
        return this.isFullScreen ? this.bigCanvas.getContext('2d') : this.smallCanvas.getContext('2d');
    }
    initBigPad() {
        this.bigCanvas = this.nspBig.nativeElement; //document.querySelector('#nsp-big');
        const fullScreenOptions = JSON.parse(JSON.stringify(this.options));
        // Calculate the fullScreen pad's size
        this.fullScreenWidth = document.documentElement.clientWidth;
        const { width: miniScreenWidth, height: miniScreenHeight } = this.options;
        this.fullScreenHeight = (this.fullScreenWidth * miniScreenWidth) / miniScreenHeight;
        // Calculate section size
        const viewHeight = document.documentElement.clientHeight;
        const space = viewHeight - this.fullScreenHeight;
        this.sectionHeight = space / 2;
        // Init pad
        fullScreenOptions.width = this.fullScreenWidth;
        fullScreenOptions.height = this.fullScreenHeight;
        const { css } = fullScreenOptions;
        this.bigCanvas.width = this.fullScreenWidth;
        this.bigCanvas.height = this.fullScreenHeight;
        for (const key in css) {
            if (Object.prototype.hasOwnProperty.call(css, key)) {
                const value = css[key];
                this.renderer2.setStyle(this.bigCanvas, key, value);
            }
        }
        this.bigPad = new SignaturePad(this.bigCanvas, fullScreenOptions);
        this.bigPad.onBegin = this._onBegin.bind(this);
        this.bigPad.onEnd = this._onEnd.bind(this);
    }
    initSmallPad() {
        this.smallCanvas = this.nspSmall.nativeElement; //document.querySelector('#nsp-small');
        const { width, height, css } = this.options;
        this.options.width = width ? width : 300;
        this.options.height = height ? height : 150;
        this.smallCanvas.width = this.options.width;
        this.smallCanvas.height = this.options.height;
        for (const key in css) {
            if (Object.prototype.hasOwnProperty.call(css, key)) {
                const value = css[key];
                this.renderer2.setStyle(this.smallCanvas, key, value);
            }
        }
        this.smallPad = new SignaturePad(this.smallCanvas, this.options);
        this.smallPad.onBegin = this._onBegin.bind(this);
        this.smallPad.onEnd = this._onEnd.bind(this);
    }
    _onBegin() {
        this.setDirty(); // When user draws, set state as dirty
        this.beginSign.emit();
    }
    _onEnd() {
        this.signDataHistory = this.toData();
        this.endSign.emit();
    }
    setPadAttribute(key, value) {
        if (this.bigPad) {
            this.bigPad[key] = value;
        }
        this.smallPad[key] = value;
    }
    constructor(renderer2, overlay, viewContainerRef) {
        this.renderer2 = renderer2;
        this.overlay = overlay;
        this.viewContainerRef = viewContainerRef;
    }
    ngAfterViewInit() {
        this.initSmallPad();
    }
    ngOnChanges(changes) {
        if (changes.options.firstChange) {
            return;
        }
        const { dotSize, minWidth, maxWidth, throttle, minDistance, backgroundColor, penColor, velocityFilterWeight, width, height, css } = changes.options.currentValue;
        if (dotSize) {
            this.setPadAttribute('dotSize', dotSize);
        }
        if (minWidth) {
            this.setPadAttribute('minWidth', minWidth);
        }
        if (maxWidth) {
            this.setPadAttribute('maxWidth', maxWidth);
        }
        if (throttle) {
            this.setPadAttribute('throttle', throttle);
        }
        if (minDistance) {
            this.setPadAttribute('minDistance', minDistance);
        }
        if (backgroundColor) {
            this.setPadAttribute('backgroundColor', backgroundColor);
        }
        if (penColor) {
            this.setPadAttribute('penColor', penColor);
        }
        if (velocityFilterWeight) {
            this.setPadAttribute('velocityFilterWeight', velocityFilterWeight);
        }
        if (width || height) {
            const { width: previousWidth, height: previousHeight } = changes.options.previousValue;
            const data = this.smallPad.toDataURL();
            const image = new Image();
            image.src = data;
            image.onload = () => {
                this.initSmallPad();
                const ctx = this.smallCanvas.getContext('2d');
                ctx.drawImage(image, 0, 0, previousWidth, previousHeight, 0, 0, width, height);
            };
        }
        if (css) {
            if (this.bigCanvas) {
                for (const key in css) {
                    if (Object.prototype.hasOwnProperty.call(css, key)) {
                        const value = css[key];
                        this.renderer2.setStyle(this.bigCanvas, key, value);
                    }
                }
            }
            if (this.smallCanvas) {
                for (const key in css) {
                    if (Object.prototype.hasOwnProperty.call(css, key)) {
                        const value = css[key];
                        this.renderer2.setStyle(this.smallCanvas, key, value);
                    }
                }
            }
        }
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.2", ngImport: i0, type: NgxSignaturePadComponent, deps: [{ token: i0.Renderer2 }, { token: i1.Overlay }, { token: i0.ViewContainerRef }], target: i0.ɵɵFactoryTarget.Component });
    static ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.0.2", type: NgxSignaturePadComponent, selector: "ngx-signature-pad", inputs: { options: "options" }, outputs: { beginSign: "beginSign", endSign: "endSign" }, viewQueries: [{ propertyName: "fullScreenTpl", first: true, predicate: ["fullScreenTpl"], descendants: true }, { propertyName: "nspSmall", first: true, predicate: ["nspSmall"], descendants: true }, { propertyName: "nspBig", first: true, predicate: ["nspBig"], descendants: true }], usesOnChanges: true, ngImport: i0, template: "<canvas #nspSmall></canvas>\n\n<ng-template #fullScreenTpl>\n  <div class=\"nsp-container\">\n    <div class=\"section left\" style=\"width: 100%;\" [ngStyle]=\"{'height': sectionHeight + 'px'}\"></div>\n    <canvas #nspBig></canvas>\n    <div class=\"section right\" style=\"width: 100%;\" [ngStyle]=\"{'height': sectionHeight + 'px'}\"></div>\n    <ng-content></ng-content>\n  </div>\n</ng-template>", styles: [".nsp-container{display:flex;flex-direction:column;position:fixed;left:0;top:0;width:100%;height:100vh;background:#fff}.nsp-container .section{flex:1}.nsp-container .section.left{border-bottom:2px dashed #dedee5}.nsp-container .section.right{border-top:2px dashed #dedee5}\n"], dependencies: [{ kind: "directive", type: i2.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }] });
}
export { NgxSignaturePadComponent };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.2", ngImport: i0, type: NgxSignaturePadComponent, decorators: [{
            type: Component,
            args: [{ selector: 'ngx-signature-pad', template: "<canvas #nspSmall></canvas>\n\n<ng-template #fullScreenTpl>\n  <div class=\"nsp-container\">\n    <div class=\"section left\" style=\"width: 100%;\" [ngStyle]=\"{'height': sectionHeight + 'px'}\"></div>\n    <canvas #nspBig></canvas>\n    <div class=\"section right\" style=\"width: 100%;\" [ngStyle]=\"{'height': sectionHeight + 'px'}\"></div>\n    <ng-content></ng-content>\n  </div>\n</ng-template>", styles: [".nsp-container{display:flex;flex-direction:column;position:fixed;left:0;top:0;width:100%;height:100vh;background:#fff}.nsp-container .section{flex:1}.nsp-container .section.left{border-bottom:2px dashed #dedee5}.nsp-container .section.right{border-top:2px dashed #dedee5}\n"] }]
        }], ctorParameters: function () { return [{ type: i0.Renderer2 }, { type: i1.Overlay }, { type: i0.ViewContainerRef }]; }, propDecorators: { options: [{
                type: Input
            }], beginSign: [{
                type: Output
            }], endSign: [{
                type: Output
            }], fullScreenTpl: [{
                type: ViewChild,
                args: ['fullScreenTpl']
            }], nspSmall: [{
                type: ViewChild,
                args: ['nspSmall', { static: false }]
            }], nspBig: [{
                type: ViewChild,
                args: ['nspBig', { static: false }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXNpZ25hdHVyZS1wYWQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9uZ3gtc2lnbmF0dXJlLXBhZC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi9zcmMvbGliL25neC1zaWduYXR1cmUtcGFkLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBRVQsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBS1osU0FBUyxFQUdWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sWUFBNkIsTUFBTSxlQUFlLENBQUM7QUFHMUQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7O0FBRXJELE1BS2Esd0JBQXdCO0lBMk5mO0lBQThCO0lBQTBCO0lBMU41RSxtREFBbUQ7SUFDM0MsUUFBUSxDQUFlO0lBQ3ZCLE1BQU0sQ0FBZTtJQUM3QixhQUFhO0lBQ2IsK0JBQStCO0lBQ3ZCLFdBQVcsQ0FBb0I7SUFDL0IsU0FBUyxDQUFvQjtJQUNyQyxhQUFhO0lBQ2IsY0FBYztJQUNOLFVBQVUsQ0FBYTtJQUN2QixNQUFNLENBQWlCO0lBQy9CLGFBQWE7SUFDTCxlQUFlLEdBQWtCLEVBQUUsQ0FBQztJQUNwQyxlQUFlLENBQVM7SUFDeEIsZ0JBQWdCLENBQVM7SUFDekIsUUFBUSxHQUFHLElBQUksQ0FBQztJQUNoQixZQUFZLEdBQUcsS0FBSyxDQUFDO0lBRTdCLGFBQWEsQ0FBUztJQUV0QixJQUFZLFNBQVM7UUFDbkIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3pELENBQUM7SUFFUSxPQUFPLEdBQXdCLEVBQUUsQ0FBQztJQUVqQyxTQUFTLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztJQUNyQyxPQUFPLEdBQUcsSUFBSSxZQUFZ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QUM7cUJBQ3ZEO2lCQUNGO2FBQ0Y7U0FDRjtJQUNILENBQUM7dUdBNVJVLHdCQUF3QjsyRkFBeEIsd0JBQXdCLGljQ3hCckMsbVpBU2M7O1NEZUQsd0JBQXdCOzJGQUF4Qix3QkFBd0I7a0JBTHBDLFNBQVM7K0JBQ0UsbUJBQW1CO3FKQTZCcEIsT0FBTztzQkFBZixLQUFLO2dCQUVJLFNBQVM7c0JBQWxCLE1BQU07Z0JBQ0csT0FBTztzQkFBaEIsTUFBTTtnQkFFcUIsYUFBYTtzQkFBeEMsU0FBUzt1QkFBQyxlQUFlO2dCQUVnQixRQUFRO3NCQUFqRCxTQUFTO3VCQUFDLFVBQVUsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUU7Z0JBQ0EsTUFBTTtzQkFBN0MsU0FBUzt1QkFBQyxRQUFRLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBSZW5kZXJlcjIsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgT25DaGFuZ2VzLFxuICBTaW1wbGVDaGFuZ2VzLFxuICBUZW1wbGF0ZVJlZixcbiAgVmlld0NoaWxkLFxuICBWaWV3Q29udGFpbmVyUmVmLFxuICBFbGVtZW50UmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IFNpZ25hdHVyZVBhZCwgeyBJUG9pbnRHcm91cCB9IGZyb20gJ3NpZ25hdHVyZV9wYWQnO1xuaW1wb3J0IHsgTmd4U2lnbmF0dXJlT3B0aW9ucyB9IGZyb20gJy4vdHlwZXMvbmd4LXNpZ25hdHVyZS1wYWQnO1xuaW1wb3J0IHsgT3ZlcmxheSwgT3ZlcmxheVJlZiB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcbmltcG9ydCB7IFRlbXBsYXRlUG9ydGFsIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BvcnRhbCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25neC1zaWduYXR1cmUtcGFkJyxcbiAgdGVtcGxhdGVVcmw6ICcuL25neC1zaWduYXR1cmUtcGFkLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vbmd4LXNpZ25hdHVyZS1wYWQuY29tcG9uZW50LnNjc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBOZ3hTaWduYXR1cmVQYWRDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMge1xuICAvLyAjcmVnaW9uIFRoZSBvYmplY3Qgb2YgZGVwZW5kZW5jeSAnc2lnYW50dXJlX3BhZCdcbiAgcHJpdmF0ZSBzbWFsbFBhZDogU2lnbmF0dXJlUGFkO1xuICBwcml2YXRlIGJpZ1BhZDogU2lnbmF0dXJlUGFkO1xuICAvLyAjZW5kcmVnaW9uXG4gIC8vICNyZWdpb24gVGhlIG9iamVjdCBvZiBjYW52YXNcbiAgcHJpdmF0ZSBzbWFsbENhbnZhczogSFRNTENhbnZhc0VsZW1lbnQ7XG4gIHByaXZhdGUgYmlnQ2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudDtcbiAgLy8gI2VuZHJlZ2lvblxuICAvLyAjcmVnaW9uIENES1xuICBwcml2YXRlIG92ZXJsYXlSZWY6IE92ZXJsYXlSZWY7XG4gIHByaXZhdGUgcG9ydGFsOiBUZW1wbGF0ZVBvcnRhbDtcbiAgLy8gI2VuZHJlZ2lvblxuICBwcml2YXRlIHNpZ25EYXRhSGlzdG9yeTogSVBvaW50R3JvdXBbXSA9IFtdO1xuICBwcml2YXRlIGZ1bGxTY3JlZW5XaWR0aDogbnVtYmVyO1xuICBwcml2YXRlIGZ1bGxTY3JlZW5IZWlnaHQ6IG51bWJlcjtcbiAgcHJpdmF0ZSBfaXNFbXB0eSA9IHRydWU7XG4gIHByaXZhdGUgaXNGdWxsU2NyZWVuID0gZmFsc2U7XG5cbiAgc2VjdGlvbkhlaWdodDogbnVtYmVyO1xuXG4gIHByaXZhdGUgZ2V0IGFjdGl2ZVBhZCgpOiBTaWduYXR1cmVQYWQge1xuICAgIHJldHVybiB0aGlzLmlzRnVsbFNjcmVlbiA/IHRoaXMuYmlnUGFkIDogdGhpcy5zbWFsbFBhZDtcbiAgfVxuXG4gIEBJbnB1dCgpIG9wdGlvbnM6IE5neFNpZ25hdHVyZU9wdGlvbnMgPSB7fTtcblxuICBAT3V0cHV0KCkgYmVnaW5TaWduID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuICBAT3V0cHV0KCkgZW5kU2lnbiA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICBAVmlld0NoaWxkKCdmdWxsU2NyZWVuVHBsJykgZnVsbFNjcmVlblRwbDogVGVtcGxhdGVSZWY8dm9pZD47XG5cbiAgQFZpZXdDaGlsZCgnbnNwU21hbGwnLCB7IHN0YXRpYzogZmFsc2UgfSkgbnNwU21hbGw6IEVsZW1lbnRSZWY7XG4gIEBWaWV3Q2hpbGQoJ25zcEJpZycsIHsgc3RhdGljOiBmYWxzZSB9KSBuc3BCaWc6IEVsZW1lbnRSZWY7XG5cbiAgZnVsbFNjcmVlbigpOiB2b2lkIHtcbiAgICB0aGlzLnBvcnRhbCA9IG5ldyBUZW1wbGF0ZVBvcnRhbCh0aGlzLmZ1bGxTY3JlZW5UcGwsIHRoaXMudmlld0NvbnRhaW5lclJlZik7XG4gICAgdGhpcy5vdmVybGF5UmVmID0gdGhpcy5vdmVybGF5LmNyZWF0ZSh7XG4gICAgICBwb3NpdGlvblN0cmF0ZWd5OiB0aGlzLm92ZXJsYXkucG9zaXRpb24oKS5nbG9iYWwoKSxcbiAgICAgIHNjcm9sbFN0cmF0ZWd5OiB0aGlzLm92ZXJsYXkuc2Nyb2xsU3RyYXRlZ2llcy5ibG9jaygpLFxuICAgICAgaGVpZ2h0OiAnMTAwJScsXG4gICAgICB3aWR0aDogJzEwMCUnXG4gICAgfSk7XG4gICAgdGhpcy5vdmVybGF5UmVmLmF0dGFjaCh0aGlzLnBvcnRhbCk7XG5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuaW5pdEJpZ1BhZCgpO1xuICAgICAgLy8gI3JlZ2lvbiBDb3B5IG1pbmlTY3JlZW4ncyBjb250ZW50IHRvIGZ1bGxTY3JlZW5cbiAgICAgIGNvbnN0IHsgd2lkdGg6IG1pbmlTY3JlZW5XaWR0aCwgaGVpZ2h0OiBtaW5pU2NyZWVuSGVpZ2h0IH0gPSB0aGlzLm9wdGlvbnM7XG4gICAgICBjb25zdCBjdHggPSB0aGlzLmJpZ0NhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuICAgICAgY3R4LnNhdmUoKTtcbiAgICAgIGN0eC50cmFuc2xhdGUodGhpcy5mdWxsU2NyZWVuV2lkdGgsIDApO1xuICAgICAgY3R4LnJvdGF0ZSgoOTAgKiBNYXRoLlBJKSAvIDE4MCk7XG4gICAgICBjdHguZHJhd0ltYWdlKHRoaXMuc21hbGxDYW52YXMsIDAsIDAsIG1pbmlTY3JlZW5XaWR0aCwgbWluaVNjcmVlbkhlaWdodCwgMCwgMCwgdGhpcy5mdWxsU2NyZWVuSGVpZ2h0LCB0aGlzLmZ1bGxTY3JlZW5XaWR0aCk7XG4gICAgICBjdHgucmVzdG9yZSgpO1xuICAgICAgLy8gI2VuZHJlZ2lvblxuICAgIH0sIDApO1xuICAgIHRoaXMuaXNGdWxsU2NyZWVuID0gdHJ1ZTtcbiAgfVxuXG4gIG1pbmlTY3JlZW4oKTogdm9pZCB7XG4gICAgdGhpcy5zbWFsbFBhZC5jbGVhcigpO1xuICAgIC8vICNyZWdpb24gQ29weSBmdWxsU2NyZWVuJ3MgY29udGVudCB0byBtaW5pU2NyZWVuXG4gICAgY29uc3QgeyB3aWR0aDogbWluaVNjcmVlbldpZHRoLCBoZWlnaHQ6IG1pbmlTY3JlZW5IZWlnaHQgfSA9IHRoaXMub3B0aW9ucztcbiAgICBjb25zdCB3aWR0aFNjYWxlID0gbWluaVNjcmVlbldpZHRoIC8gdGhpcy5mdWxsU2NyZWVuSGVpZ2h0O1xuICAgIGNvbnN0IGhlaWdodFNjYWxlID0gbWluaVNjcmVlbkhlaWdodCAvIHRoaXMuZnVsbFNjcmVlbldpZHRoO1xuICAgIGNvbnN0IGN0eCA9IHRoaXMuc21hbGxDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICBjdHguc2F2ZSgpO1xuICAgIGN0eC50cmFuc2xhdGUoMCwgbWluaVNjcmVlbkhlaWdodCk7XG4gICAgY3R4LnJvdGF0ZSgoLTkwICogTWF0aC5QSSkgLyAxODApO1xuICAgIGN0eC5kcmF3SW1hZ2UoXG4gICAgICB0aGlzLmJpZ0NhbnZhcyxcbiAgICAgIDAsXG4gICAgICAwLFxuICAgICAgdGhpcy5mdWxsU2NyZWVuV2lkdGgsXG4gICAgICB0aGlzLmZ1bGxTY3JlZW5IZWlnaHQsXG4gICAgICAwLFxuICAgICAgMCxcbiAgICAgIHRoaXMuZnVsbFNjcmVlbldpZHRoICogd2lkdGhTY2FsZSxcbiAgICAgIHRoaXMuZnVsbFNjcmVlbkhlaWdodCAqIGhlaWdodFNjYWxlXG4gICAgKTtcbiAgICBjdHgucmVzdG9yZSgpO1xuICAgIC8vICNlbmRyZWdpb25cbiAgICB0aGlzLm92ZXJsYXlSZWYuZGlzcG9zZSgpO1xuICAgIHRoaXMuYmlnQ2FudmFzID0gbnVsbDtcbiAgICB0aGlzLmJpZ1BhZCA9IG51bGw7XG4gICAgdGhpcy5pc0Z1bGxTY3JlZW4gPSBmYWxzZTtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIHNpZ25hdHVyZSBpbWFnZSBhcyBhbiBhcnJheSBvZiBwb2ludCBncm91cHMgKi9cbiAgdG9EYXRhKCk6IElQb2ludEdyb3VwW10ge1xuICAgIHJldHVybiB0aGlzLmFjdGl2ZVBhZC50b0RhdGEoKTtcbiAgfVxuXG4gIC8qKiBEcmF3cyBzaWduYXR1cmUgaW1hZ2UgZnJvbSBhbiBhcnJheSBvZiBwb2ludCBncm91cHMgKi9cbiAgZnJvbURhdGEocG9pbnRHcm91cHM6IElQb2ludEdyb3VwW10pOiB2b2lkIHtcbiAgICB0aGlzLmFjdGl2ZVBhZC5mcm9tRGF0YShwb2ludEdyb3Vwcyk7XG4gIH1cblxuICB0b0RhdGFVUkwodHlwZT86ICdpbWFnZS9qcGVnJyB8ICdpbWFnZS9zdmcreG1sJyk6IHN0cmluZyB7XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlICdpbWFnZS9qcGVnJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuYWN0aXZlUGFkLnRvRGF0YVVSTCgnaW1hZ2UvanBlZycpO1xuICAgICAgY2FzZSAnaW1hZ2Uvc3ZnK3htbCc6XG4gICAgICAgIHJldHVybiB0aGlzLmFjdGl2ZVBhZC50b0RhdGFVUkwoJ2ltYWdlL3N2Zyt4bWwnKTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiB0aGlzLmFjdGl2ZVBhZC50b0RhdGFVUkwoKTtcbiAgICB9XG4gIH1cblxuICBmcm9tRGF0YVVSTChcbiAgICBkYXRhVXJsOiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IHtcbiAgICAgIHJhdGlvPzogbnVtYmVyO1xuICAgICAgd2lkdGg/OiBudW1iZXI7XG4gICAgICBoZWlnaHQ/OiBudW1iZXI7XG4gICAgfSxcbiAgICBjYWxsYmFjaz86IChlcnJvcj86IEVycm9yRXZlbnQpID0+IHZvaWRcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5hY3RpdmVQYWQuZnJvbURhdGFVUkwoZGF0YVVybCwgb3B0aW9ucywgY2FsbGJhY2spO1xuICB9XG5cbiAgcmV2ZXJ0KCk6IHZvaWQge1xuICAgIHRoaXMuc2lnbkRhdGFIaXN0b3J5LnBvcCgpO1xuICAgIHRoaXMuZnJvbURhdGEodGhpcy5zaWduRGF0YUhpc3RvcnkpO1xuICAgIGlmICh0aGlzLnNpZ25EYXRhSGlzdG9yeS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuc2V0RW1wdHkoKTtcbiAgICB9XG4gIH1cblxuICAvLyBDbGVhcnMgdGhlIGNhbnZhc1xuICBjbGVhcigpOiB2b2lkIHtcbiAgICB0aGlzLnNldEVtcHR5KCk7XG4gICAgdGhpcy5zaWduRGF0YUhpc3RvcnkgPSBbXTtcbiAgICB0aGlzLmFjdGl2ZVBhZC5jbGVhcigpO1xuICB9XG5cbiAgLyoqIFJldHVybiB0cnVlIGlmIGNhbnZhcyBpcyBlbXB0eSwgb3RoZXJ3aXNlIHJldHVybiBmYWxzZSAqL1xuICBpc0VtcHR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9pc0VtcHR5O1xuICB9XG5cbiAgLyoqIFNldCBjYW52YXMncyBzdGF0ZSBhcyBkaXJ0eSAqL1xuICBzZXREaXJ0eSgpOiB2b2lkIHtcbiAgICB0aGlzLl9pc0VtcHR5ID0gZmFsc2U7XG4gIH1cblxuICAvKiogU2V0IGNhbnZhcydzIHN0YXRlIGFzIGVtcHR5ICovXG4gIHNldEVtcHR5KCk6IHZvaWQge1xuICAgIHRoaXMuX2lzRW1wdHkgPSB0cnVlO1xuICB9XG5cbiAgZ2V0Q29udGV4dCgpOiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQge1xuICAgIHJldHVybiB0aGlzLmlzRnVsbFNjcmVlbiA/IHRoaXMuYmlnQ2FudmFzLmdldENvbnRleHQoJzJkJykgOiB0aGlzLnNtYWxsQ2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gIH1cblxuICBwcml2YXRlIGluaXRCaWdQYWQoKTogdm9pZCB7XG4gICAgdGhpcy5iaWdDYW52YXMgPSB0aGlzLm5zcEJpZy5uYXRpdmVFbGVtZW50OyAvL2RvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNuc3AtYmlnJyk7XG4gICAgY29uc3QgZnVsbFNjcmVlbk9wdGlvbnMgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMub3B0aW9ucykpO1xuICAgIC8vIENhbGN1bGF0ZSB0aGUgZnVsbFNjcmVlbiBwYWQncyBzaXplXG4gICAgdGhpcy5mdWxsU2NyZWVuV2lkdGggPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGg7XG4gICAgY29uc3QgeyB3aWR0aDogbWluaVNjcmVlbldpZHRoLCBoZWlnaHQ6IG1pbmlTY3JlZW5IZWlnaHQgfSA9IHRoaXMub3B0aW9ucztcbiAgICB0aGlzLmZ1bGxTY3JlZW5IZWlnaHQgPSAodGhpcy5mdWxsU2NyZWVuV2lkdGggKiBtaW5pU2NyZWVuV2lkdGgpIC8gbWluaVNjcmVlbkhlaWdodDtcbiAgICAvLyBDYWxjdWxhdGUgc2VjdGlvbiBzaXplXG4gICAgY29uc3Qgdmlld0hlaWdodCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQ7XG4gICAgY29uc3Qgc3BhY2UgPSB2aWV3SGVpZ2h0IC0gdGhpcy5mdWxsU2NyZWVuSGVpZ2h0O1xuICAgIHRoaXMuc2VjdGlvbkhlaWdodCA9IHNwYWNlIC8gMjtcbiAgICAvLyBJbml0IHBhZFxuICAgIGZ1bGxTY3JlZW5PcHRpb25zLndpZHRoID0gdGhpcy5mdWxsU2NyZWVuV2lkdGg7XG4gICAgZnVsbFNjcmVlbk9wdGlvbnMuaGVpZ2h0ID0gdGhpcy5mdWxsU2NyZWVuSGVpZ2h0O1xuICAgIGNvbnN0IHsgY3NzIH0gPSBmdWxsU2NyZWVuT3B0aW9ucztcbiAgICB0aGlzLmJpZ0NhbnZhcy53aWR0aCA9IHRoaXMuZnVsbFNjcmVlbldpZHRoO1xuICAgIHRoaXMuYmlnQ2FudmFzLmhlaWdodCA9IHRoaXMuZnVsbFNjcmVlbkhlaWdodDtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBjc3MpIHtcbiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoY3NzLCBrZXkpKSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gY3NzW2tleV07XG4gICAgICAgIHRoaXMucmVuZGVyZXIyLnNldFN0eWxlKHRoaXMuYmlnQ2FudmFzLCBrZXksIHZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5iaWdQYWQgPSBuZXcgU2lnbmF0dXJlUGFkKHRoaXMuYmlnQ2FudmFzLCBmdWxsU2NyZWVuT3B0aW9ucyk7XG4gICAgdGhpcy5iaWdQYWQub25CZWdpbiA9IHRoaXMuX29uQmVnaW4uYmluZCh0aGlzKTtcbiAgICB0aGlzLmJpZ1BhZC5vbkVuZCA9IHRoaXMuX29uRW5kLmJpbmQodGhpcyk7XG4gIH1cblxuICBwcml2YXRlIGluaXRTbWFsbFBhZCgpOiB2b2lkIHtcbiAgICB0aGlzLnNtYWxsQ2FudmFzID0gdGhpcy5uc3BTbWFsbC5uYXRpdmVFbGVtZW50OyAvL2RvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNuc3Atc21hbGwnKTtcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQsIGNzcyB9ID0gdGhpcy5vcHRpb25zO1xuICAgIHRoaXMub3B0aW9ucy53aWR0aCA9IHdpZHRoID8gd2lkdGggOiAzMDA7XG4gICAgdGhpcy5vcHRpb25zLmhlaWdodCA9IGhlaWdodCA/IGhlaWdodCA6IDE1MDtcbiAgICB0aGlzLnNtYWxsQ2FudmFzLndpZHRoID0gdGhpcy5vcHRpb25zLndpZHRoO1xuICAgIHRoaXMuc21hbGxDYW52YXMuaGVpZ2h0ID0gdGhpcy5vcHRpb25zLmhlaWdodDtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBjc3MpIHtcbiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoY3NzLCBrZXkpKSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gY3NzW2tleV07XG4gICAgICAgIHRoaXMucmVuZGVyZXIyLnNldFN0eWxlKHRoaXMuc21hbGxDYW52YXMsIGtleSwgdmFsdWUpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnNtYWxsUGFkID0gbmV3IFNpZ25hdHVyZVBhZCh0aGlzLnNtYWxsQ2FudmFzLCB0aGlzLm9wdGlvbnMpO1xuICAgIHRoaXMuc21hbGxQYWQub25CZWdpbiA9IHRoaXMuX29uQmVnaW4uYmluZCh0aGlzKTtcbiAgICB0aGlzLnNtYWxsUGFkLm9uRW5kID0gdGhpcy5fb25FbmQuYmluZCh0aGlzKTtcbiAgfVxuXG4gIHByaXZhdGUgX29uQmVnaW4oKTogdm9pZCB7XG4gICAgdGhpcy5zZXREaXJ0eSgpOyAvLyBXaGVuIHVzZXIgZHJhd3MsIHNldCBzdGF0ZSBhcyBkaXJ0eVxuICAgIHRoaXMuYmVnaW5TaWduLmVtaXQoKTtcbiAgfVxuXG4gIHByaXZhdGUgX29uRW5kKCk6IHZvaWQge1xuICAgIHRoaXMuc2lnbkRhdGFIaXN0b3J5ID0gdGhpcy50b0RhdGEoKTtcbiAgICB0aGlzLmVuZFNpZ24uZW1pdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRQYWRBdHRyaWJ1dGUoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5iaWdQYWQpIHtcbiAgICAgIHRoaXMuYmlnUGFkW2tleV0gPSB2YWx1ZTtcbiAgICB9XG4gICAgdGhpcy5zbWFsbFBhZFtrZXldID0gdmFsdWU7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlbmRlcmVyMjogUmVuZGVyZXIyLCBwcml2YXRlIG92ZXJsYXk6IE92ZXJsYXksIHByaXZhdGUgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZikge31cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy5pbml0U21hbGxQYWQoKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoY2hhbmdlcy5vcHRpb25zLmZpcnN0Q2hhbmdlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHsgZG90U2l6ZSwgbWluV2lkdGgsIG1heFdpZHRoLCB0aHJvdHRsZSwgbWluRGlzdGFuY2UsIGJhY2tncm91bmRDb2xvciwgcGVuQ29sb3IsIHZlbG9jaXR5RmlsdGVyV2VpZ2h0LCB3aWR0aCwgaGVpZ2h0LCBjc3MgfSA9XG4gICAgICBjaGFuZ2VzLm9wdGlvbnMuY3VycmVudFZhbHVlO1xuICAgIGlmIChkb3RTaXplKSB7XG4gICAgICB0aGlzLnNldFBhZEF0dHJpYnV0ZSgnZG90U2l6ZScsIGRvdFNpemUpO1xuICAgIH1cbiAgICBpZiAobWluV2lkdGgpIHtcbiAgICAgIHRoaXMuc2V0UGFkQXR0cmlidXRlKCdtaW5XaWR0aCcsIG1pbldpZHRoKTtcbiAgICB9XG4gICAgaWYgKG1heFdpZHRoKSB7XG4gICAgICB0aGlzLnNldFBhZEF0dHJpYnV0ZSgnbWF4V2lkdGgnLCBtYXhXaWR0aCk7XG4gICAgfVxuICAgIGlmICh0aHJvdHRsZSkge1xuICAgICAgdGhpcy5zZXRQYWRBdHRyaWJ1dGUoJ3Rocm90dGxlJywgdGhyb3R0bGUpO1xuICAgIH1cbiAgICBpZiAobWluRGlzdGFuY2UpIHtcbiAgICAgIHRoaXMuc2V0UGFkQXR0cmlidXRlKCdtaW5EaXN0YW5jZScsIG1pbkRpc3RhbmNlKTtcbiAgICB9XG4gICAgaWYgKGJhY2tncm91bmRDb2xvcikge1xuICAgICAgdGhpcy5zZXRQYWRBdHRyaWJ1dGUoJ2JhY2tncm91bmRDb2xvcicsIGJhY2tncm91bmRDb2xvcik7XG4gICAgfVxuICAgIGlmIChwZW5Db2xvcikge1xuICAgICAgdGhpcy5zZXRQYWRBdHRyaWJ1dGUoJ3BlbkNvbG9yJywgcGVuQ29sb3IpO1xuICAgIH1cbiAgICBpZiAodmVsb2NpdHlGaWx0ZXJXZWlnaHQpIHtcbiAgICAgIHRoaXMuc2V0UGFkQXR0cmlidXRlKCd2ZWxvY2l0eUZpbHRlcldlaWdodCcsIHZlbG9jaXR5RmlsdGVyV2VpZ2h0KTtcbiAgICB9XG4gICAgaWYgKHdpZHRoIHx8IGhlaWdodCkge1xuICAgICAgY29uc3QgeyB3aWR0aDogcHJldmlvdXNXaWR0aCwgaGVpZ2h0OiBwcmV2aW91c0hlaWdodCB9ID0gY2hhbmdlcy5vcHRpb25zLnByZXZpb3VzVmFsdWU7XG4gICAgICBjb25zdCBkYXRhID0gdGhpcy5zbWFsbFBhZC50b0RhdGFVUkwoKTtcbiAgICAgIGNvbnN0IGltYWdlID0gbmV3IEltYWdlKCk7XG4gICAgICBpbWFnZS5zcmMgPSBkYXRhO1xuICAgICAgaW1hZ2Uub25sb2FkID0gKCkgPT4ge1xuICAgICAgICB0aGlzLmluaXRTbWFsbFBhZCgpO1xuICAgICAgICBjb25zdCBjdHggPSB0aGlzLnNtYWxsQ2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1hZ2UsIDAsIDAsIHByZXZpb3VzV2lkdGgsIHByZXZpb3VzSGVpZ2h0LCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTtcbiAgICAgIH07XG4gICAgfVxuICAgIGlmIChjc3MpIHtcbiAgICAgIGlmICh0aGlzLmJpZ0NhbnZhcykge1xuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBjc3MpIHtcbiAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGNzcywga2V5KSkge1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBjc3Nba2V5XTtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIyLnNldFN0eWxlKHRoaXMuYmlnQ2FudmFzLCBrZXksIHZhbHVlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnNtYWxsQ2FudmFzKSB7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIGNzcykge1xuICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoY3NzLCBrZXkpKSB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGNzc1trZXldO1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJlcjIuc2V0U3R5bGUodGhpcy5zbWFsbENhbnZhcywga2V5LCB2YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iLCI8Y2FudmFzICNuc3BTbWFsbD48L2NhbnZhcz5cblxuPG5nLXRlbXBsYXRlICNmdWxsU2NyZWVuVHBsPlxuICA8ZGl2IGNsYXNzPVwibnNwLWNvbnRhaW5lclwiPlxuICAgIDxkaXYgY2xhc3M9XCJzZWN0aW9uIGxlZnRcIiBzdHlsZT1cIndpZHRoOiAxMDAlO1wiIFtuZ1N0eWxlXT1cInsnaGVpZ2h0Jzogc2VjdGlvbkhlaWdodCArICdweCd9XCI+PC9kaXY+XG4gICAgPGNhbnZhcyAjbnNwQmlnPjwvY2FudmFzPlxuICAgIDxkaXYgY2xhc3M9XCJzZWN0aW9uIHJpZ2h0XCIgc3R5bGU9XCJ3aWR0aDogMTAwJTtcIiBbbmdTdHlsZV09XCJ7J2hlaWdodCc6IHNlY3Rpb25IZWlnaHQgKyAncHgnfVwiPjwvZGl2PlxuICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAgPC9kaXY+XG48L25nLXRlbXBsYXRlPiJdfQ==